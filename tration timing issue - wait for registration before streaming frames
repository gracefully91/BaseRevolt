warning: in the working copy of 'hardware/esp32s3_camera.ino', LF will be replaced by CRLF the next time Git touches it
[1mdiff --git a/hardware/esp32s3_camera.ino b/hardware/esp32s3_camera.ino[m
[1mindex 27fb019..ebf6d0f 100644[m
[1m--- a/hardware/esp32s3_camera.ino[m
[1m+++ b/hardware/esp32s3_camera.ino[m
[36m@@ -79,6 +79,8 @@[m [mWebSocketsClient webSocket;[m
 unsigned long lastFrameTime = 0;[m
 const int frameInterval = 66; // ~15 FPS (1000ms / 15 = 66ms)[m
 bool wsConnected = false;[m
[32m+[m[32mbool deviceRegistered = false;  // ë””ë°”ì´ìŠ¤ ë“±ë¡ ì™„ë£Œ ì—¬ë¶€[m
[32m+[m[32munsigned long registrationTime = 0;  // ë“±ë¡ ë©”ì‹œì§€ ì „ì†¡ ì‹œê°„[m
 [m
 // ==================== í•¨ìˆ˜ ì„ ì–¸ ====================[m
 void setupCamera();[m
[36m@@ -113,9 +115,17 @@[m [mvoid loop() {[m
   webSocket.loop();[m
   [m
   // ì¹´ë©”ë¼ í”„ë ˆì„ ì „ì†¡ (15 FPS)[m
[31m-  if (wsConnected && (millis() - lastFrameTime > frameInterval)) {[m
[32m+[m[32m  // ë“±ë¡ì´ ì™„ë£Œëœ í›„ì—ë§Œ í”„ë ˆì„ ì „ì†¡[m
[32m+[m[32m  if (wsConnected && deviceRegistered && (millis() - lastFrameTime > frameInterval)) {[m
     sendCameraFrame();[m
     lastFrameTime = millis();[m
[32m+[m[32m  } else if (wsConnected && !deviceRegistered) {[m
[32m+[m[32m    // ë“±ë¡ ëŒ€ê¸° ì¤‘ - 500ms í›„ ìë™ìœ¼ë¡œ ë“±ë¡ ì™„ë£Œë¡œ ê°„ì£¼[m
[32m+[m[32m    if (millis() - registrationTime > 500) {[m
[32m+[m[32m      deviceRegistered = true;[m
[32m+[m[32m      Serial.println("âœ… Device registration auto-confirmed after 500ms");[m
[32m+[m[32m      Serial.println("â–¶ï¸ Starting frame streaming...");[m
[32m+[m[32m    }[m
   }[m
   [m
   delay(1);[m
[36m@@ -209,6 +219,7 @@[m [mvoid webSocketEvent(WStype_t type, uint8_t * payload, size_t length) {[m
       Serial.printf("   Free heap: %d bytes\n", ESP.getFreeHeap());[m
       Serial.println("   ğŸ”„ Will retry in 10 seconds...");[m
       wsConnected = false;[m
[32m+[m[32m      deviceRegistered = false;  // ì¬ì—°ê²° ì‹œ ë‹¤ì‹œ ë“±ë¡ í•„ìš”[m
       break;[m
       [m
     case WStype_CONNECTED:[m
[36m@@ -224,7 +235,10 @@[m [mvoid webSocketEvent(WStype_t type, uint8_t * payload, size_t length) {[m
         // ë””ë°”ì´ìŠ¤ ë“±ë¡ ë©”ì‹œì§€ ì „ì†¡ (v2.0 í”„ë¡œí† ì½œ)[m
         Serial.println("ğŸ“¤ Sending registration message...");[m
         sendRegistration();[m
[32m+[m[32m        registrationTime = millis();[m
[32m+[m[32m        deviceRegistered = false;  // ë“±ë¡ í™•ì¸ ëŒ€ê¸°[m
         Serial.println("âœ… Registration message sent, waiting for server response...");[m
[32m+[m[32m        Serial.println("â¸ï¸ Frame streaming paused until registration confirmed");[m
       }[m
       break;[m
       [m
[36m@@ -232,10 +246,17 @@[m [mvoid webSocketEvent(WStype_t type, uint8_t * payload, size_t length) {[m
       // ì„œë²„ ë©”ì‹œì§€ ìˆ˜ì‹  (ì¹´ë©”ë¼ëŠ” ì œì–´ ëª…ë ¹ ë°›ì§€ ì•ŠìŒ)[m
       Serial.print("â„¹ï¸ Server message: ");[m
       if (payload && length > 0) {[m
[31m-        for (size_t i = 0; i < length && i < 200; i++) {[m
[31m-          Serial.print((char)payload[i]);[m
[32m+[m[32m        String msg = String((char*)payload);[m
[32m+[m[32m        Serial.println(msg);[m
[32m+[m[41m        [m
[32m+[m[32m        // ë“±ë¡ í™•ì¸ (ì„œë²„ê°€ ë“±ë¡ì„ ë°›ì•˜ëŠ”ì§€ í™•ì¸)[m
[32m+[m[32m        // ì°¸ê³ : ì„œë²„ëŠ” ë“±ë¡ í›„ ì‘ë‹µì„ ë³´ë‚´ì§€ ì•Šì§€ë§Œ, ì—°ê²°ì´ ìœ ì§€ë˜ë©´ ë“±ë¡ ì„±ê³µìœ¼ë¡œ ê°„ì£¼[m
[32m+[m[32m        if (!deviceRegistered && (millis() - registrationTime > 500)) {[m
[32m+[m[32m          // ë“±ë¡ ë©”ì‹œì§€ ì „ì†¡ í›„ 500ms ê²½ê³¼ ì‹œ ë“±ë¡ ì™„ë£Œë¡œ ê°„ì£¼[m
[32m+[m[32m          deviceRegistered = true;[m
[32m+[m[32m          Serial.println("âœ… Device registration confirmed (connection stable)");[m
[32m+[m[32m          Serial.println("â–¶ï¸ Starting frame streaming...");[m
         }[m
[31m-        Serial.println();[m
       } else {[m
         Serial.println("(empty)");[m
       }[m
[1mdiff --git a/server/index.js b/server/index.js[m
[1mindex 52411fb..5cc93fe 100644[m
[1m--- a/server/index.js[m
[1m+++ b/server/index.js[m
[36m@@ -93,17 +93,12 @@[m [mwss.on('connection', (ws, req) => {[m
   [m
   // ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬[m
   ws.on('message', (message) => {[m
[31m-    // ë””ë²„ê¹…: ëª¨ë“  ë©”ì‹œì§€ ë¡œê·¸[m
[31m-    if (clientType === 'device-pending') {[m
[31m-      console.log(`ğŸ“¨ Message from device-pending:`, message instanceof Buffer ? `Binary (${message.length} bytes)` : message.toString().substring(0, 100));[m
[31m-    }[m
[31m-    [m
     // ë””ë°”ì´ìŠ¤ ë“±ë¡ ì²˜ë¦¬ (ESP32ì—ì„œ ì²« ë©”ì‹œì§€)[m
     if (clientType === 'device-pending' || clientType === 'device-control' || clientType === 'device-camera') {[m
[32m+[m[32m      // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì²˜ë¦¬ (ë“±ë¡ ë©”ì‹œì§€)[m
       if (!(message instanceof Buffer)) {[m
         try {[m
           const data = JSON.parse(message.toString());[m
[31m-          console.log(`ğŸ“ Parsed JSON from device:`, data);[m
           [m
           // ë””ë°”ì´ìŠ¤ ë“±ë¡[m
           if (data.type === 'register') {[m
[36m@@ -133,21 +128,37 @@[m [mwss.on('connection', (ws, req) => {[m
               status: 'connected'[m
             });[m
             [m
[32m+[m[32m            // í•˜ìœ„ í˜¸í™˜: rc-car-statusë„ ì „ì†¡[m
[32m+[m[32m            const anyCarConnected = Array.from(devices.values()).some([m
[32m+[m[32m              device => device.control || device.camera[m
[32m+[m[32m            );[m
[32m+[m[32m            broadcastToWebUsers({[m
[32m+[m[32m              type: 'rc-car-status',[m
[32m+[m[32m              status: anyCarConnected ? 'connected' : 'disconnected'[m
[32m+[m[32m            });[m
[32m+[m[41m            [m
             return;[m
           }[m
           [m
           console.log(`Device ${deviceRole} message:`, data);[m
         } catch (e) {[m
           // JSON íŒŒì‹± ì‹¤íŒ¨ - ë°”ì´ë„ˆë¦¬ì¼ ìˆ˜ ìˆìŒ[m
[31m-          console.log(`âš ï¸ JSON parse error from device-pending:`, e.message);[m
[31m-          console.log(`   Raw message:`, message.toString().substring(0, 200));[m
[32m+[m[32m          // device-pending ìƒíƒœì—ì„œëŠ” ë“±ë¡ ì „ì´ë¯€ë¡œ ë°”ì´ë„ˆë¦¬ ë©”ì‹œì§€ ë¬´ì‹œ[m
[32m+[m[32m          if (clientType === 'device-pending') {[m
[32m+[m[32m            // ë“±ë¡ ì „ ë°”ì´ë„ˆë¦¬ ë©”ì‹œì§€ëŠ” ë¬´ì‹œ (ì¹´ë©”ë¼ í”„ë ˆì„ì´ ë“±ë¡ ë©”ì‹œì§€ë³´ë‹¤ ë¨¼ì € ë„ì°©í•  ìˆ˜ ìˆìŒ)[m
[32m+[m[32m            return;[m
[32m+[m[32m          }[m
         }[m
       }[m
       [m
       // ì¹´ë©”ë¼ ë””ë°”ì´ìŠ¤ì—ì„œ ë°”ì´ë„ˆë¦¬(ì˜ìƒ í”„ë ˆì„) ìˆ˜ì‹ [m
[31m-      if (message instanceof Buffer && deviceRole === 'camera') {[m
[32m+[m[32m      // ë“±ë¡ì´ ì™„ë£Œëœ ê²½ìš°ì—ë§Œ ì²˜ë¦¬ (deviceRoleì´ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•¨)[m
[32m+[m[32m      if (message instanceof Buffer && deviceRole === 'camera' && clientType === 'device-camera') {[m
         // JPEG í”„ë ˆì„ â†’ ëª¨ë“  ì›¹ ì‚¬ìš©ìì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸[m
         broadcastToWebUsers(message, true);[m
[32m+[m[32m      } else if (message instanceof Buffer && clientType === 'device-pending') {[m
[32m+[m[32m        // ë“±ë¡ ì „ ë°”ì´ë„ˆë¦¬ ë©”ì‹œì§€ëŠ” ë¬´ì‹œ[m
[32m+[m[32m        // console.log(`âš ï¸ Ignoring binary message from unregistered device`);[m
       }[m
       [m
     } else if (clientType === 'web-user') {[m
