// wrapWalletForMiniApp.js - RainbowKit Wallet ë˜í¼ (ëª¨ë°”ì¼ ë”¥ë§í¬ ìë™ ì˜¤í”ˆ)

import { buildDeeplinkCandidates, tryDeeplinkCandidates } from './wcDeeplink';

/**
 * RainbowKit Walletì„ ë˜í•‘í•˜ì—¬ ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ ë”¥ë§í¬ë¥¼ ìë™ìœ¼ë¡œ ì—½ë‹ˆë‹¤
 * @param {Function} walletFactory - RainbowKit wallet factory function
 * @param {string} target - ì§€ê°‘ íƒ€ì… ('metamask' | 'coinbase' | 'trust' | 'phantom' | 'rainbow')
 * @returns {Function} ë˜í•‘ëœ wallet factory
 */
export function wrapWalletForMiniApp(walletFactory, target) {
  return (options) => {
    const wallet = walletFactory(options);
    
    console.log(`ğŸ”§ Wrapping wallet for Mini-App: ${target}`);
    
    return {
      ...wallet,
      // ëª¨ë°”ì¼ì—ì„œ getUriê°€ í˜¸ì¶œë˜ëŠ” ìˆœê°„ ë”¥ë§í¬ë¡œ ì•± ì˜¤í”ˆ
      mobile: wallet.mobile ? {
        ...wallet.mobile,
        getUri: (wcUri) => {
          console.log(`ğŸ“± Mobile getUri called for ${target}:`, wcUri.substring(0, 30) + '...');
          const candidates = buildDeeplinkCandidates(target, wcUri);
          
          // ë”¥ë§í¬ í›„ë³´ë“¤ë¡œ ì§€ê°‘ ì•± ì—´ê¸° ì‹œë„
          tryDeeplinkCandidates(candidates);
          
          // RainbowKit ë‚´ë¶€ê°€ ë¬¸ìì—´ì„ í•„ìš”ë¡œ í•˜ë¯€ë¡œ ë°˜í™˜ ìœ ì§€
          return wcUri;
        },
      } : undefined,
      
      // QR ì½”ë“œ íƒ­ì—ì„œë„ ë™ì¼í•˜ê²Œ ë”¥ë§í¬ ì˜¤í”ˆ (ì„ íƒì‚¬í•­)
      qrCode: wallet.qrCode ? {
        ...wallet.qrCode,
        getUri: (wcUri) => {
          console.log(`ğŸ”² QR getUri called for ${target}:`, wcUri.substring(0, 30) + '...');
          const candidates = buildDeeplinkCandidates(target, wcUri);
          
          // ë”¥ë§í¬ í›„ë³´ë“¤ë¡œ ì§€ê°‘ ì•± ì—´ê¸° ì‹œë„
          tryDeeplinkCandidates(candidates);
          
          return wcUri;
        },
        instructions: {
          ...wallet.qrCode.instructions,
          steps: [
            {
              step: 'install',
              title: `Open ${wallet.name} App`,
              description: `The ${wallet.name} app will open automatically to connect.`,
            },
            {
              step: 'scan',
              title: 'Approve Connection',
              description: `Approve the connection request in your ${wallet.name} app.`,
            },
            {
              step: 'refresh',
              title: 'Return to Browser',
              description: 'Return to this page after approving the connection.',
            },
          ],
        },
      } : undefined,
    };
  };
}

